#!/usr/bin/python
# Taken from https://github.com/xournalpp/xournalpp/issues/2204/

import os
import sys
import subprocess

workdir = sys.argv[1]
xournal_cmd = '/usr/bin/flatpak run com.github.xournalpp.xournalpp'

def grade_xopp(workdir, xournal_cmd):
    """
    Randomly cycles through xopp's in workdir (setup for pdf annotations and created using instantiate_xopp)
    in workdir.  You grade, save,  and close the xopp then it will open the next one.

    Parameters
    ----------
    workdir : string
        Directory location of xopp files to grade

    Returns
    -------
    None.
    """
    xournal_cmd = xournal_cmd.split(' ')
    if workdir[-1]!='/':
        workdir = workdir +'/'
    files = os.listdir(workdir)
    files.sort()
    count = 0
    xopp_files = [f for f in files if f.endswith(".xopp")]
    totfiles = len(xopp_files)
    for file in files:
        if file.endswith(".xopp"):
            print(f"Working on file: {file}")
            print("File number - %2.0f of %2.0f." % (count+1, totfiles))
            #pdb.set_trace()
            p = subprocess.Popen([*xournal_cmd, workdir+file], stderr=subprocess.DEVNULL)
            # wait until file closed by user
            p.wait()
            count+=1

grade_xopp(workdir, xournal_cmd)

